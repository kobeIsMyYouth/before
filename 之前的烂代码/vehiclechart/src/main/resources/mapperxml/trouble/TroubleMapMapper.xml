<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://www.mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="team.hfut.vehiclechart.mapper.trouble.TroubleMapMapper">

	<resultMap id="MapResultMap"
		type="team.hfut.vehiclechart.bean.trouble.TroubleMapBean">
		<result column="provice" property="provice" />
		<collection property="childs" column="provice"
			ofType="team.hfut.vehiclechart.bean.base.KeyValBean" javaType="ArrayList"
			resultMap="keyValueMap" />
	</resultMap>

	<resultMap id="keyValueMap" type="team.hfut.vehiclechart.bean.base.KeyValBean">
		<id column="name" property="name" />
		<result column="value" property="value" />
	</resultMap>

	<resultMap id="HistoryListMap"
		type="team.hfut.vehiclechart.bean.trouble.TroubleHistoryBean">
		<id column="trouble_type" property="trouble_type" />
		<id column="trouble_name" property="trouble_name" />
		<collection property="childs" column="trouble_name"
			ofType="team.hfut.vehiclechart.bean.base.KeyValBean" javaType="ArrayList"
			resultMap="keyValueMap" />
	</resultMap>

	<select id="selectCountList" resultType="map"
		parameterType="team.hfut.vehiclechart.bean.trouble.TroubleParamBean">
		SELECT COUNT(0) count_value,'故障数量' count_title,'number' value_type,'个' count_unit FROM `result_trouble`
		<where>
		<if test="provice != null and provice != ''  ">
			and provice = #{provice}
		</if>
		<if test="pid != null and pid != ''  ">
			and trouble_type like CONCAT(#{pid},'%') 
		</if>
		<if test="month != null and month != ''  ">
			and DATE_FORMAT(record_time,'%Y/%m') = #{month}
		</if>
		</where>
		UNION
		SELECT COUNT(DISTINCT trouble_type) count_value,'涉及故障类别' count_title,'number' value_type,'个' count_unit FROM `result_trouble`
		<where>
		<if test="provice != null and provice != ''  ">
			and provice = #{provice}
		</if>
		<if test="pid != null and pid != ''  ">
			and trouble_type like CONCAT(#{pid},'%') 
		</if>
		<if test="month != null and month != ''  ">
			and DATE_FORMAT(record_time,'%Y/%m') = #{month}
		</if>
		</where>
		UNION
		SELECT GROUP_CONCAT( DISTINCT bd.dict_name SEPARATOR '，' ) count_value, '涉及故障类别' count_title, 'text' value_type, '' count_unit FROM `result_trouble` rt LEFT JOIN base_dict bd ON bd.id = LEFT(rt.trouble_type,CHAR_LENGTH(#{pid})+2)
		<where>
		<if test="provice != null and provice != ''  ">
			and rt.provice = #{provice}
		</if>
		<if test="pid != null and pid != ''  ">
			and rt.trouble_type like CONCAT(#{pid},'%') 
		</if>
		<if test="month != null and month != ''  ">
			and DATE_FORMAT(rt.record_time,'%Y/%m') = #{month}
		</if>
		</where>
	</select>

	<select id="selectTroubleMap" resultMap="MapResultMap"
		parameterType="team.hfut.vehiclechart.bean.trouble.TroubleParamBean">
		set @type = #{pid};
		SELECT rt.provice,bd.dict_name `name`,COUNT(rt.id)
		`value` FROM result_trouble rt
		INNER JOIN base_dict bd ON bd.id =
		LEFT (
				rt.trouble_type,
				CHAR_LENGTH(@type) + 2
			)
		WHERE rt.trouble_type LIKE CONCAT(@type,'%')
		<if test="month != null and month != ''  ">
			and DATE_FORMAT(rt.record_time,'%Y/%m') = #{month}
		</if>
		GROUP BY rt.provice,LEFT (
				rt.trouble_type,
				CHAR_LENGTH(@type) + 2
			)
	</select>

	<select id="selectTroubleTree" resultType="map"
		parameterType="team.hfut.vehiclechart.bean.trouble.TroubleParamBean">
		SELECT bd.id type,bd.dict_name `name`,SUM(rt.trouble_num) `value` FROM base_dict bd 
		INNER JOIN (SELECT trouble_type,COUNT(0) trouble_num FROM result_trouble 
		<where>
			<if test="provice != null and provice != ''  ">
				and provice = #{provice}
			</if>
			<if test="month != null and month != ''  ">
				and DATE_FORMAT(record_time,'%Y/%m') = #{month}
			</if>		
		</where>
		GROUP BY trouble_type) rt ON rt.trouble_type LIKE CONCAT(bd.id,'%') 
		WHERE bd.id LIKE CONCAT(#{pid},'%')
		GROUP BY bd.id
	</select>

	<select id="selectHistoryList" resultMap="HistoryListMap"
		parameterType="team.hfut.vehiclechart.bean.trouble.TroubleParamBean">
		SET @type = #{pid};

		SELECT
		bc.id trouble_type,
		bc.dict_name trouble_name,
		DATE_FORMAT(
		rt.record_time,
		'%Y/%m'
		) `name`,
		COUNT(0) `value`
		FROM
		result_trouble rt
		INNER JOIN base_dict bc ON bc.id = LEFT (
		rt.trouble_type,
		CHAR_LENGTH(@type) + 2
		)
		WHERE
		rt.trouble_type LIKE CONCAT(@type, '%')
		<if test="provice != null and provice != ''  ">
			and rt.provice = #{provice}
		</if>
		<if test="month != null and month != ''  ">
			and DATE_FORMAT(rt.record_time,'%Y/%m') = #{month}
		</if>
		GROUP BY
		LEFT (
		rt.trouble_type,
		CHAR_LENGTH(@type) + 2
		),
		DATE_FORMAT(rt.record_time, '%Y%m')
		ORDER BY
		trouble_name,
		`name` ASC
	</select>

</mapper>
